#! /usr/bin/env python
import irclib
import ircbot
import time
import sys
import thread

class Bot(ircbot.SingleServerIRCBot):
    def __init__ (self, channels, nick, server, port, password, name):
        ircbot.SingleServerIRCBot.__init__(self, [(server,port)], nick, name, 10)
        self.nick = nick
        self.mychannels = channels
        self.password = password
        self.currentHour = self.getHour()
        self.currentMin = self.getMin() #sets current hour and minute, minute doesn't do anything right now
        thread.start_new_thread(self.wait, ()) #listens for the time change in a separate thread so we can listen for input as well
        self.array = []
        self.message = '' #message for the .time command
    def getHour(self):
        theTime = time.gmtime()#does things for GMT
        longHour = theTime.tm_hour #using this because I am far more comfortable with C than I am with Python
        shortHour = longHour % 12
        shortHour += 1 #>Daylight savings time
        return shortHour
    def on_kick(self, c, e):
        kickedNick = e.arguments()[0]
        if kickedNick == self.nick: #only does the following if the bot was the one that is kicked
            time.sleep(10)#waits 10 seconds
            for channel in self.mychannels:
                self.connection.join(channel) #joins all the channels if kicked, joining a channel the bot is already in is okay
    def getMin(self):
        theTime = time.gmtime()
        return theTime.tm_min
    
    def get_version(self):
        return "BIGBEN BOT" #CTCP VERSION reply

    def wait(self): #sounds off the hour
        message = ''
        while 1:
            if self.currentHour != self.getHour():
                self.currentHour = self.getHour() #makes it so the bongs only go off once
                for i in range (0, self.currentHour):
                    message += 'BONG '
                for channel in self.channels:
                    self.connection.privmsg(channel, message)
                message = '' #resets the message
            time.sleep(1) #only checks once a second to greatly reduce CPU usage
    def on_welcome(self, connection, event):
        for channel in self.mychannels:
            connection.join(channel)
        self.connection.privmsg("nickserv", "identify "+self.password) #idntify with nickserv
    def on_pubmsg (self, connection, event):
        if event.arguments() [0] == '.time':
            self.array.append('OI IT\'S ')
            if self.getMin() > 45:
                self.array.append('ALMOST ')
                self.array.append(str(self.getHour() + 1))
            else:
                self.array.append(str(self.getHour()))
            if (self.getMin() > 15 and self.getMin() <= 30):
                self.array.append(' AND A QUARTER')
            if (self.getMin() > 30 and self.getMin() <= 45):
                self.array.append(' AND A HALF')
            self.array.append(' BONG')
            self.message = ''.join(self.array)
            self.connection.privmsg(event.target(), self.message)
            self.message = ''
            self.array = [] #say OI IT'S x BONG

    def on_privmsg (self, connection, event):  #the user specifies the channel after the command
        eventList = event.arguments()[0].split(' ')
        if eventList[0] == '.time':
            self.array.append('OI IT\'S ')
            if self.getMin() > 45:
                self.array.append('ALMOST ')
                self.array.append(str(self.getHour() + 1))
            else:
                self.array.append(str(self.getHour()))
            if (self.getMin() > 15 and self.getMin() <= 30):
                self.array.append(' AND A QUARTER')
            if (self.getMin() > 30 and self.getMin() <= 45):
                self.array.append(' AND A HALF')
            self.array.append(' BONG')
            self.message = ''.join(self.array)
            self.connection.privmsg(eventList[1], self.message)
            self.message = ''
            self.array = [] #say OI IT'S x BONG

def main():
    if len(sys.argv) != 6:
        print "Usage: BigBen <network[:port]> <#channel #channel2> <nickname> <password> <ircname>" #prints usage
        sys.exit(1)

    s = sys.argv[1].split(":", 1)
    network = s[0]
    if len(s) == 2:
        try:
            port = int(s[1])
        except ValueError:
            print "Error: Erroneous port."
            sys.exit(1) #splits server and port
    else:
        port = 6667
    channels = sys.argv[2].split(' ') #creates the list of channels, the # is required
    nick = sys.argv[3] #nick
    password = sys.argv[4] #nickserv password
    name = sys.argv[5] #ircname
    bot = Bot(channels, nick, network, port, password, name)
    bot.start()

if __name__ == "__main__":
    main()
